"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClient } from "../../src/lib/supabase/client";
import { CATEGORIES } from "../../src/vault/oscars2026/categories";
import { MOVIES } from "../../src/vault/oscars2026/movies";
import { ROTTEN_BY_TITLE } from "../../src/vault/oscars2026/rotten.manual";
import BrandLogo from "../../src/components/brand/BrandLogo";
import type { Category, Nominee } from "../../src/vault/oscars2026/categories";

type Pick = { win?: string; second?: string; fav?: string };
type PicksByCategory = Record<string, Pick>;
type SeenByNominee = Record<string, boolean>;

type Media = {
  ok: boolean;
  posterUrl?: string | null;
  trailerUrl?: string | null;
  tmdbId?: number | null;
};

function normalizeTitle(s: string) {
  return s
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

function clsx(...parts: Array<string | false | null | undefined>) {
  return parts.filter(Boolean).join(" ");
}

export default function BallotPage() {
  const router = useRouter();
  const supabase = useMemo(() => createClient(), []);

  const rottenByMovieId = useMemo(() => {
    const byNormTitle = new Map<string, number | null>();
    for (const r of ROTTEN_BY_TITLE) byNormTitle.set(normalizeTitle(r.title), r.score);

    const out: Record<string, number | null> = {};
    for (const m of MOVIES) {
      const a = byNormTitle.get(normalizeTitle(m.title));
      const b = m.titleCo ? byNormTitle.get(normalizeTitle(m.titleCo)) : undefined;
      out[m.id] = (a !== undefined ? a : b !== undefined ? b : null) ?? null;
    }
    return out;
  }, []);

  const [status, setStatus] = useState<"checking" | "ok" | "guest">("checking");
  const [email, setEmail] = useState<string | null>(null);
  const [userId, setUserId] = useState<string | null>(null);

  const [activeCategoryId, setActiveCategoryId] = useState(CATEGORIES[0]?.id ?? "");
  const [picks, setPicks] = useState<PicksByCategory>({});
  const [seen, setSeenState] = useState<SeenByNominee>({});
  const [msg, setMsg] = useState<string | null>(null);

  const [saving, setSaving] = useState(false);
  const [savedMsg, setSavedMsg] = useState<string | null>(null);

  const [media, setMedia] = useState<Record<string, Media>>({});
  const [imdbMap, setImdbMap] = useState<Record<string, string | null>>({});

  const activeCategory: Category =
    CATEGORIES.find((c) => c.id === activeCategoryId) ?? CATEGORIES[0];

  // Cierre de votaciones: 15 de marzo 2026, 16:00 (Colombia, UTC-5)
  // Nota: esto bloquea cambios en UI. Puedes ver la boleta igual.
  const closesAt = new Date("2026-03-15T16:00:00-05:00");
  const isClosed = Date.now() >= closesAt.getTime();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const { data } = await supabase.auth.getUser();
      const user = data.user ?? null;

      if (cancelled) return;

      if (!user) {
        setStatus("guest");
        router.replace("/login");
        return;
      }

      setEmail(user.email ?? null);
      setUserId(user.id);
      setStatus("ok");

      // Cargar votos guardados (silencioso)
      const { data: rows } = await supabase
        .from("votes")
        .select("category_id, win, second, fav")
        .eq("user_id", user.id);

      if (cancelled) return;

      const next: PicksByCategory = {};
      const seenNext: SeenByNominee = {};

      for (const r of rows ?? []) {
        next[r.category_id] = {
          win: r.win ?? undefined,
          second: r.second ?? undefined,
          fav: r.fav ?? undefined,
        };
        if (r.fav) seenNext[r.fav] = true;
      }

      setPicks(next);
      setSeenState((prev) => ({ ...prev, ...seenNext }));
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  useEffect(() => {
    // Media de películas (TMDB cacheado en Supabase)
    (async () => {
      try {
        const res = await fetch("/api/tmdb/movies");
        const json = await res.json();
        if (res.ok) setMedia(json);
      } catch {}
    })();

    // IMDb rating (OMDb)
    (async () => {
      try {
        const res = await fetch("/api/imdb/movies");
        const json = await res.json();
        if (!res.ok) return;

        const next: Record<string, string | null> = {};
        for (const k of Object.keys(json || {})) {
          next[k] = json[k]?.imdbRating ?? null;
        }
        setImdbMap(next);
      } catch {}
    })();
  }, []);

  async function logout() {
    await supabase.auth.signOut();
    router.replace("/login");
  }

  function setSeen(nomineeId: string, value: boolean) {
    setSavedMsg(null);
    setMsg(null);

    setSeenState((prev) => ({ ...prev, [nomineeId]: value }));

    // Si desmarca "ya la vi" y esa era su favorita, quitamos favorita
    if (!value) {
      setPicks((prev) => {
        const next = { ...prev };
        for (const catId of Object.keys(next)) {
          if (next[catId]?.fav === nomineeId) {
            next[catId] = { ...next[catId], fav: undefined };
          }
        }
        return next;
      });
    }
  }

  function updatePick(categoryId: string, patch: Partial<Pick>) {
    setMsg(null);
    setSavedMsg(null);

    setPicks((prev) => {
      const current = prev[categoryId] ?? {};
      const next: Pick = { ...current, ...patch };

      // Regla: win y second no pueden ser iguales
      if (next.win && next.second && next.win === next.second) {
        setMsg("Tu 1ra y 2da opción deben ser distintas.");
        return prev;
      }

      // Si elijo win y coincide con second, limpiamos second (y viceversa)
      if (patch.win && current.second === patch.win) next.second = undefined;
      if (patch.second && current.win === patch.second) next.win = undefined;

      return { ...prev, [categoryId]: next };
    });
  }

  function buttonStyle(active: boolean) {
    return clsx(
      "rounded-lg px-3 py-2 text-sm font-medium border",
      active
        ? "bg-white text-black border-white"
        : "bg-black/40 text-white border-white/15 hover:border-white/30"
    );
  }

  async function saveCurrentCategory() {
    setMsg(null);
    setSavedMsg(null);

    if (!userId) {
      setMsg("No hay sesión. Vuelve a entrar.");
      return;
    }

    const v = picks[activeCategoryId] ?? {};
    if (v.win && v.second && v.win === v.second) {
      setMsg("Tu 1ra y 2da opción deben ser distintas.");
      return;
    }

    setSaving(true);

    const payload = {
      user_id: userId,
      category_id: activeCategoryId,
      win: v.win ?? null,
      second: v.second ?? null,
      fav: v.fav ?? null,
      updated_at: new Date().toISOString(),
    };

    const { error } = await supabase
      .from("votes")
      .upsert(payload, { onConflict: "user_id,category_id" });

    setSaving(false);

    if (error) {
      setMsg("No pude guardar. Intenta otra vez.");
      return;
    }

    setSavedMsg("Guardado ✅");
  }

  if (status === "checking") {
    return (
      <main className="min-h-screen flex items-center justify-center p-6">
        <div className="text-white/70">Cargando…</div>
      </main>
    );
  }

  if (status === "guest") {
    return (
      <main className="min-h-screen flex items-center justify-center p-6">
        <div className="text-white/70">Redirigiendo a login…</div>
      </main>
    );
  }

  const currentPick = picks[activeCategoryId] ?? {};

  return (
    <main className="min-h-screen p-6 flex justify-center">
      <div className="w-full max-w-5xl">
        <header className="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
          <div>
            <h1 className="text-3xl font-semibold">Boleta</h1>

            {isClosed ? (
              <div className="mt-3 rounded-xl border border-white/15 bg-black/40 p-3 text-sm text-white/80">
                Votaciones cerradas. Puedes ver tu boleta, pero ya no puedes cambiarla.
              </div>
            ) : null}

            <p className="mt-2 text-white/70">Sesión activa{email ? `: ${email}` : "."}</p>

            {msg ? (
              <div className="mt-3 rounded-xl border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">
                {msg}
              </div>
            ) : null}

            {savedMsg ? (
              <div className="mt-3 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-3 text-sm text-emerald-200">
                {savedMsg}
              </div>
            ) : null}
          </div>

          <div className="flex flex-wrap gap-2">
            <button
              className="rounded-xl border border-white/15 bg-black/40 px-4 py-2 font-medium"
              onClick={() => router.replace("/")}
            >
              Inicio
            </button>

            {!isClosed ? (
              <button
                className={clsx(
                  "rounded-xl px-4 py-2 font-medium",
                  saving ? "bg-white/70 text-black" : "bg-white text-black"
                )}
                disabled={saving}
                onClick={saveCurrentCategory}
              >
                {saving ? "Guardando…" : "Guardar"}
              </button>
            ) : null}

            <button
              className="rounded-xl border border-white/15 bg-black/40 px-4 py-2 font-medium"
              onClick={logout}
            >
              Cerrar sesión
            </button>
          </div>
        </header>

        <div className="mt-6 rounded-2xl border border-white/10 bg-black/30 p-5">
          <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <h2 className="text-xl font-semibold">{activeCategory?.name ?? "Categoría"}</h2>
              <p className="mt-1 text-sm text-white/70">
                Elige por clicks: 1ra opción, 2da opción y tu favorita (solo si la marcaste como vista).
              </p>
            </div>

            <div className="flex flex-wrap gap-2">
              {CATEGORIES.map((c: Category) => (
                <button
                  key={c.id}
                  className={clsx(
                    "rounded-xl px-3 py-2 text-sm font-medium border",
                    c.id === activeCategoryId
                      ? "bg-white text-black border-white"
                      : "bg-black/40 text-white border-white/15 hover:border-white/30"
                  )}
                  onClick={() => {
                    setSavedMsg(null);
                    setMsg(null);
                    setActiveCategoryId(c.id);
                  }}
                >
                  {c.name}
                </button>
              ))}
            </div>
          </div>

          <div className="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {activeCategory?.nominees.map((n: Nominee) => {
              const isWin = currentPick.win === n.id;
              const isSecond = currentPick.second === n.id;
              const isFav = currentPick.fav === n.id;
              const hasSeen = !!seen[n.id];

              // Si aún no tienes movieId en tus datos, no se rompe: cae a n.id
              const movieId = (n as any).movieId ?? n.id;

              const m = media[movieId] ?? null;
              const imdb = imdbMap[movieId] ?? null;

              return (
                <div key={n.id} className="rounded-2xl border border-white/10 bg-black/30 p-4">
                  <div className="aspect-[2/3] w-full rounded-xl border border-white/10 bg-black/40 overflow-hidden flex items-center justify-center">
                    {m?.posterUrl ? (
                      <img src={m.posterUrl} alt={n.title} className="h-full w-full object-cover" />
                    ) : (
                      <div className="text-white/40 text-sm">Poster</div>
                    )}
                  </div>

                  <div className="mt-3">
                    <div className="font-semibold">{n.title}</div>
                    {n.subtitle ? <div className="text-sm text-white/70">{n.subtitle}</div> : null}
                  </div>

                  <div className="mt-2 flex gap-2 items-center">
                    {m?.trailerUrl ? (
                      <a
                        href={m.trailerUrl}
                        target="_blank"
                        rel="noreferrer"
                        className="rounded-lg px-3 py-2 text-sm font-medium border bg-black/40 text-white border-white/15 hover:border-white/30"
                      >
                        Ver tráiler
                      </a>
                    ) : (
                      <div className="text-xs text-white/50">Tráiler: —</div>
                    )}
                  </div>

                  <label className="mt-3 flex items-center gap-2 text-sm text-white/80">
                    <input
                      type="checkbox"
                      checked={hasSeen}
                      onChange={(e) => {
                        if (isClosed) return;
                        setSeen(n.id, e.target.checked);
                      }}
                    />
                    Ya la vi
                  </label>

                  <div className="mt-3 grid grid-cols-3 gap-2">
                    <button
                      className={buttonStyle(isWin)}
                      onClick={() => {
                        if (isClosed) return;
                        updatePick(activeCategoryId, { win: isWin ? undefined : n.id });
                      }}
                    >
                      Gana
                    </button>

                    <button
                      className={buttonStyle(isSecond)}
                      onClick={() => {
                        if (isClosed) return;
                        updatePick(activeCategoryId, { second: isSecond ? undefined : n.id });
                      }}
                    >
                      2da
                    </button>

                    <button
                      className={clsx(buttonStyle(isFav), !hasSeen && "opacity-50 cursor-not-allowed")}
                      onClick={() => {
                        if (isClosed) return;
                        if (!hasSeen) {
                          setMsg("Para elegir tu favorita, primero marca “Ya la vi”.");
                          return;
                        }
                        updatePick(activeCategoryId, { fav: isFav ? undefined : n.id });
                      }}
                      disabled={!hasSeen || isClosed}
                    >
                      Favorita
                    </button>
                  </div>

                  <div className="mt-3 flex flex-wrap items-center gap-3 text-xs text-white/80">
                    <span className="inline-flex items-center gap-2">
                      <BrandLogo kind="imdb" />
                      <span>{imdb ?? "—"}</span>
                    </span>

                    <span className="inline-flex items-center gap-2">
                      <BrandLogo kind="rt" />
                      <span>{rottenByMovieId[movieId] ?? "—"}</span>
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </main>
  );
}
